---
output: 
  html_document:
    keep_md: yes
---
<!--
to do:
 - install / check Rmarkdown @ RPi
 - write geojson as RDS to disk
 - update.sh <- /usr/bin/Rscript rmarkdown::render("README.Rmd")
 - archive/infizierte & archive/tote
 - update .gitignore
 - test on dev-branch
 - merge to master
-->
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(ggplot2)
library(tidyr)
library(dplyr)
library(readr)
library(rgdal)
library(leaflet)
```

# COVID-19 Infektionen in Deutschland
Das Rohland-Koch Institut veröffentlicht seit Anfang März 2020 
auf ihrer Website tagesaktuell die Anzahl an bekannten Corona-infizierten, aufgeschlüsselt nach Bundesland.
Diese Repo dient dazu, den Verlauf zu protokollieren, da zwar eine Historie 
in PDF Dokumenten erstellt, aber keine CSV zur verfügung gestellt wird. Diese
Lücke soll hier geschlossen werden.

Hinterlegt werden die Anzahl der Infizierten und Todesfälle.

Das RKI aktualisiert jedoch teilweise verzögert, daher werden um 23:30 Uhr werden  die vom RKI am Tag veröffentlichten Daten abgefragt und in eine
CSV eingetragen. 

### Der zeitliche Verlauf
```{r verlauf, message=FALSE, warning=FALSE}

read_csv(list.files(pattern = "infizierte")) %>%
  pivot_longer(cols = -c(Datum, Gesamt), 
               names_to = "Bundesland", 
               values_to = "Anzahl Infizierte") %>%
  ggplot(aes(x = Datum, y = `Anzahl Infizierte`, color = Bundesland)) +
  geom_line() +
  labs(caption = paste("Quelle: RKI | Stand:", Sys.Date()),
       x = "")
```

Datenlieferung für NRW am 10.03.2020 scheint unvollständig zu sein. 

```{r include=FALSE}
geo <- readOGR("3_mittel.geojson")
```

### Der Aktuelle Stand 
```{r leaflet, echo=FALSE, message=FALSE, warning=FALSE}

inf <- read_csv(list.files(pattern = "infizierte")) %>%
  filter(Datum == max(Datum)) %>%
  select(-c(Datum, Gesamt)) %>%
  pivot_longer(cols = everything(),
               names_to = "land",
               values_to = "infiziert")
tot <- read_csv(list.files(pattern = "tote")) %>%
  filter(Datum == max(Datum)) %>%
  select(-c(Datum, Gesamt)) %>%
  pivot_longer(cols = everything(),
               names_to = "land",
               values_to = "tot")
geo@data <- inner_join(geo@data, inf, by = c("NAME_1" = "land")) %>%
  inner_join(tot, by = c("NAME_1" = "land")) %>%
  mutate(beschreibung = paste0("<b>", NAME_1, "</b><br>Infiziert: ", infiziert, "<br>Verstorben: ", tot))

pal <- colorNumeric("viridis", NULL, reverse = T)
leaflet(geo) %>%
  addTiles() %>%
  addPolygons(stroke = FALSE,
              fillOpacity = 0.7,
              fillColor = ~pal(log(infiziert)),
              popup = ~beschreibung)

```

